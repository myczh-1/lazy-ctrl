lazy-ctrl 功能模块规划文档

## 系统架构概述

lazy-ctrl 采用分层架构设计，支持三种使用模式：
1. **本地模式**：手机/PC → HTTP → 本地Controller → 执行命令
2. **云端模式**：手机/PC → HTTP → 云端Gateway → gRPC → 本地Controller → 执行命令  
3. **第三方云模式**：第三方云 → MQTT → 本地Controller → 执行命令

## 1. 控制器 Agent（Go 实现）- 核心执行引擎
位置：本地电脑，负责执行脚本和提供多协议通信接口。

### - 多协议服务支持：HTTP/gRPC/MQTT 三协议并存
  - 功能目标：
    - **HTTP Server**：供本地直连使用（内网场景）
    - **gRPC Server**：供云端Gateway调用（云端场景）
    - **MQTT Client**：对接第三方IoT平台（如阿里云IoT、腾讯云IoT）
    - 三协议共享同一套命令执行核心

  - 技术实现：
    - 启动时同时开启三种协议服务
    - 统一的命令路由和执行引擎
    - 协议间状态同步机制

### - 命令注册/管理：支持注册常用命令或脚本（如 mute、shutdown）
  - 功能目标：
    - 支持用户将常用系统脚本（如 mute、shutdown）注册为命令 ID
    - 支持平台特定命令配置（Windows/macOS/Linux）
    - 提供统一调用接口，所有协议均可使用
    - 支持动态配置热重载

  - 技术实现：
    - 使用本地 JSON 配置文件（`config/commands.json`）
    - 支持嵌套配置结构，按平台区分命令
    - Go 启动时读取并缓存配置
    - 提供配置重载 API

### - 命令执行器：执行本地脚本或系统指令
  - 功能目标：
    - 统一封装系统调用执行入口
    - 支持超时控制和上下文取消
    - 跨平台命令适配（Windows cmd/PowerShell，Unix shell）
    - 输出标准输出/错误并返回执行状态

### - 状态反馈：返回脚本执行结果、输出、是否成功等
  - 功能目标：
    - 标准化响应结构：成功状态 + 输出 + 错误信息 + 执行时间
    - 支持流式输出（长时间运行的命令）
    - 执行日志记录机制

### - 安全限制：多层安全防护机制
  - 功能目标：
    - 命令白名单机制，只允许执行预注册命令
    - 路径隔离，限制脚本执行范围
    - 可选PIN校验，防止未授权访问
    - 执行频率限制，防止恶意调用

---

## 2. 控制前端（Taro + 微信小程序/H5 实现）
位置：终端控制界面，用户通过手机操作本地电脑

### - 连接模式管理：支持多种连接方式
  - 功能目标：
    - **本地直连模式**：扫码或输入IP直接连接本地Agent
    - **云端模式**：通过云端Gateway连接本地Agent
    - **第三方云模式**：显示MQTT连接状态
    - 连接状态实时显示和自动重连

### - 脚本控制页面：展示当前可用脚本，点击执行
  - 功能目标：
    - 动态获取和展示所有已注册脚本
    - 支持分类展示（系统控制、应用启动、自定义脚本等）
    - 一键执行，支持确认对话框防误操作
    - 支持批量操作和快捷操作

### - 状态反馈：展示执行结果、是否成功、输出日志等
  - 功能目标：
    - 实时展示脚本执行状态与输出反馈
    - 支持长时间任务的进度显示
    - 错误提示与重试机制
    - 执行历史记录查看

### - 配置界面：设备管理和脚本配置
  - 功能目标：
    - 设备连接配置（IP、端口、认证信息）
    - 脚本别名、图标、分组管理
    - 安全设置（PIN码、指纹验证等）
    - 连接偏好设置

---

## 3. 云端Gateway服务（Node.js + Midway 实现）
位置：云端中转服务，提供设备管理和gRPC转发功能

### - 用户认证与设备管理
  - 功能目标：
    - 支持多种登录方式（微信、手机号、邮箱等）
    - 设备注册与绑定机制
    - 多人共享设备权限管理
    - 设备分组和标签管理

  - 技术实现：
    - JWT Token认证机制
    - 设备UUID生成和管理
    - Redis缓存设备在线状态
    - 权限控制中间件

### - gRPC客户端：与本地Agent通信
  - 功能目标：
    - 作为gRPC客户端调用本地Agent服务
    - 支持连接池和负载均衡
    - 自动重连和故障转移
    - 请求响应日志记录

  - 技术实现：
    - gRPC连接管理器
    - 心跳检测机制
    - 超时和重试策略
    - 流式调用支持

### - REST API服务：供前端调用
  - 功能目标：
    - 提供标准RESTful接口
    - 设备控制命令转发
    - 设备状态查询
    - 执行历史记录管理

### - 实时通信：WebSocket推送
  - 功能目标：
    - 命令执行状态实时推送
    - 设备在线状态变化通知
    - 多端同步显示
    - 断线重连机制

---

## 4. 第三方云平台集成（MQTT支持）
位置：支持对接主流IoT云平台

### - MQTT客户端集成
  - 功能目标：
    - 支持阿里云IoT、腾讯云IoT、AWS IoT等主流平台
    - 标准MQTT 3.1.1/5.0协议支持
    - 自动重连和消息持久化
    - 主题订阅和发布管理

### - 消息格式标准化
  - 功能目标：
    - 定义统一的命令消息格式
    - 支持JSON和二进制消息
    - 消息加密和签名验证
    - 错误处理和状态反馈

---

## 5. 部署和开发模式

### - 开发模式
  - 本地开发：Go Agent + 前端同时运行
  - 调试支持：详细日志和错误信息
  - 热重载：配置文件变更自动生效

### - 生产部署
  - **极简部署**：单个Go二进制文件，下载即用
  - **完整部署**：Go Agent + 云端Gateway + 前端
  - **混合部署**：本地Agent + 云端Gateway，前端可选

### - 跨平台支持
  - Windows/macOS/Linux一键编译
  - ARM架构支持（树莓派、NAS等）
  - Docker容器化部署
  - 自动更新机制